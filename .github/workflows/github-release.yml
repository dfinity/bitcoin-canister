name: Create GitHub Releases

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Which release to create'
        required: true
        type: choice
        options:
          - ic-btc-canister # Creates ic-btc-canister/release/YYYY-MM-DD
          - watchdog        # Creates watchdog/release/YYYY-MM-DD

# Creates GitHub releases for date-based canisters:
# - ic-btc-canister: date-based tag with WASM artifact
# - watchdog: date-based tag with WASM artifact
#
# For semver crates (ic-btc-interface, ic-btc-validation):
# Tags are created by release-plz when publishing to crates.io (see publish-crates.yml)

jobs:
  # ===== ic-btc-canister Release (date-based) =====
  bitcoin-canister-release:
    name: Release ic-btc-canister
    if: ${{ inputs.release_type == 'ic-btc-canister' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download WASM artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const allArtifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "wasms",
            });
            const mainArtifacts = allArtifacts
              .filter(artifact => !artifact.expired)
              .filter(artifact => artifact.workflow_run.head_branch === "master");
            
            mainArtifacts.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
            const latestMainArtifact = mainArtifacts[0];
            if(!latestMainArtifact) {
              throw new Error("Could not find 'wasms' artifact from branch master");
            }
            console.log("Found 'wasms' artifact for commit", latestMainArtifact.workflow_run.head_sha);
            
            const { url } = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: latestMainArtifact.id,
              archive_format: "zip",
            });
            await exec.exec('curl', ['-sSL', url, '-o', "wasms.zip"]);
            await exec.exec('unzip', ["wasms.zip", "ic-btc-canister.wasm.gz", "-d", "wasms"]);
            await exec.exec('rm', ["wasms.zip"]);

      - name: SHA256 of WASM artifact
        run: |
          echo "WASM_SHA256=$(shasum -a 256 ./wasms/ic-btc-canister.wasm.gz | cut -d ' ' -f1)" >> "$GITHUB_ENV"

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release tag and notes
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          RELEASE_TAG="ic-btc-canister/release/${RELEASE_DATE}"
          echo "RELEASE_TAG=$RELEASE_TAG" >> "$GITHUB_ENV"
          echo "RELEASE_DATE=$RELEASE_DATE" >> "$GITHUB_ENV"
          
          # Find previous tag: prefer ic-btc-canister/release/*, fallback to release/*
          PREV_TAG=$(git tag --list 'ic-btc-canister/release/*' --sort=-version:refname | head -n1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git tag --list 'release/*' --sort=-version:refname | head -n1)
          fi
          
          # Generate changelog with git-cliff (scoped to canister/ directory)
          # Strip the version title line (e.g., "## [release/2026-01-21] - 2026-01-21")
          CHANGELOG=$(git-cliff --config cliff.toml \
            --include-path "canister/**" \
            --unreleased \
            --tag "$RELEASE_TAG" \
            --strip header \
            "${PREV_TAG}.." | sed '/^## \[.*\] - /d')
          
          # Build release body
          CHECKSUMS="## SHA-256

          \`\`\`
          ${WASM_SHA256}  ic-btc-canister.wasm.gz
          \`\`\`"
          
          PROPOSALS="## Proposals

          [TO BE ADDED]"
          
          RELEASE_BODY="${CHANGELOG}

          ${CHECKSUMS}

          ${PROPOSALS}"
          
          # Export multiline variable
          echo "RELEASE_BODY<<EOF" >> "$GITHUB_ENV"
          echo "$RELEASE_BODY" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ env.RELEASE_TAG }}
          name: ic-btc-canister/release/${{ env.RELEASE_DATE }}
          body: ${{ env.RELEASE_BODY }}
          files: |
            wasms/ic-btc-canister.wasm.gz
            canister/candid.did

  # ===== watchdog Release (date-based) =====
  watchdog-canister-release:
    name: Release watchdog
    if: ${{ inputs.release_type == 'watchdog' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download WASM artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const allArtifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "wasms",
            });
            const mainArtifacts = allArtifacts
              .filter(artifact => !artifact.expired)
              .filter(artifact => artifact.workflow_run.head_branch === "master");
            
            mainArtifacts.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
            const latestMainArtifact = mainArtifacts[0];
            if(!latestMainArtifact) {
              throw new Error("Could not find 'wasms' artifact from branch master");
            }
            console.log("Found 'wasms' artifact for commit", latestMainArtifact.workflow_run.head_sha);
            
            const { url } = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: latestMainArtifact.id,
              archive_format: "zip",
            });
            await exec.exec('curl', ['-sSL', url, '-o', "wasms.zip"]);
            await exec.exec('unzip', ["wasms.zip", "watchdog.wasm.gz", "-d", "wasms"]);
            await exec.exec('rm', ["wasms.zip"]);

      - name: SHA256 of WASM artifact
        run: |
          echo "WASM_SHA256=$(shasum -a 256 ./wasms/watchdog.wasm.gz | cut -d ' ' -f1)" >> "$GITHUB_ENV"

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release tag and notes
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          RELEASE_TAG="watchdog/release/${RELEASE_DATE}"
          echo "RELEASE_TAG=$RELEASE_TAG" >> "$GITHUB_ENV"
          echo "RELEASE_DATE=$RELEASE_DATE" >> "$GITHUB_ENV"
          
          # Find previous tag: prefer watchdog/release/*, fallback to release/*
          PREV_TAG=$(git tag --list 'watchdog/release/*' --sort=-version:refname | head -n1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git tag --list 'release/*' --sort=-version:refname | head -n1)
          fi
          
          # Generate changelog with git-cliff (scoped to watchdog/ directory)
          # Strip the version title line (e.g., "## [release/2026-01-21] - 2026-01-21")
          CHANGELOG=$(git-cliff --config cliff.toml \
            --include-path "watchdog/**" \
            --unreleased \
            --tag "$RELEASE_TAG" \
            --strip header \
            "${PREV_TAG}.." | sed '/^## \[.*\] - /d')
          
          # Build release body
          CHECKSUMS="## SHA-256

          \`\`\`
          ${WASM_SHA256}  watchdog.wasm.gz
          \`\`\`"
          
          PROPOSALS="## Proposals

          [TO BE ADDED]"
          
          RELEASE_BODY="${CHANGELOG}

          ${CHECKSUMS}

          ${PROPOSALS}"
          
          # Export multiline variable
          echo "RELEASE_BODY<<EOF" >> "$GITHUB_ENV"
          echo "$RELEASE_BODY" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ env.RELEASE_TAG }}
          name: watchdog/release/${{ env.RELEASE_DATE }}
          body: ${{ env.RELEASE_BODY }}
          files: |
            wasms/watchdog.wasm.gz
            watchdog/candid.did

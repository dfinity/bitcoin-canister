name: Release & Publish

on:
  pull_request

# This workflow handles two types of releases:
# 1. Canister releases (ic-btc-canister, watchdog): date-based tags (release/YYYY-MM-DD)
#    - Creates GitHub release with WASM artifacts
#    - NOT published to crates.io
# 2. Library crates (ic-btc-interface, ic-btc-validation): semver tags (vX.Y.Z)
#    - Published to crates.io via release-plz
#    - NO GitHub release (crate releases only)

jobs:
  release:
    name: Release & Publish
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: write
      id-token: write # Required for OIDC token exchange

    concurrency:
      group: publish
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download build for Release Candidate
        #     Adapted from [Internet Identity](https://github.com/dfinity/internet-identity/blob/c33e9f65a8045cbedde6f96cfb7f7cb677694fc9/.github/workflows/deploy-rc.yml#L22)
        uses: actions/github-script@v7
        with:
          script: |
            // Find all artifacts for the production build, and filter for non-expired main artifacts
            const allArtifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "wasms",
            });
            const mainArtifacts = allArtifacts
              .filter(artifact => !artifact.expired)
              .filter(artifact => artifact.workflow_run.head_branch === "main");
            
            // Grab the latest artifact
            mainArtifacts.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
            const latestMainArtifact = mainArtifacts[0];
            if(!latestMainArtifact) {
              const message = "Could not find 'wasms' artifact from branch main. Are artifacts expired?";
              console.error(message);
              throw new Error(message);
            }
            console.log("Found 'wasms' artifact for commit", latestMainArtifact.workflow_run.head_sha);
            
            // Download and unzip artifact
            const { url } = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: latestMainArtifact.id,
              archive_format: "zip",
            });
            await exec.exec('curl', ['-sSL', url, '-o', "wasms.zip"]);
            await exec.exec('unzip', ["wasms.zip", "-d", "wasms"]);
            await exec.exec('rm', ["wasms.zip"]);
            await exec.exec('ls', ["-la", "wasms"]);

      - name: SHA256 of release assets
        run: |
          set -e
          SHA256=$(shasum -a 256 ./wasms/ic-btc-canister.wasm.gz | cut -d ' ' -f1)
          echo "SHA256 of ic-btc-canister.wasm.gz: $SHA256"
          echo "IC_BTC_CANISTER_WASM_GZ_SHA256=$SHA256" >> "$GITHUB_ENV"

          SHA256=$(shasum -a 256 ./wasms/watchdog.wasm.gz | cut -d ' ' -f1)
          echo "SHA256 of watchdog.wasm.gz: $SHA256"
          echo "WATCHDOG_WASM_GZ_SHA256=$SHA256" >> "$GITHUB_ENV"

          SHA256=$(shasum -a 256 ./wasms/uploader.wasm.gz | cut -d ' ' -f1)
          echo "SHA256 of uploader.wasm.gz: $SHA256"

      - name: Generate release tag and notes
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const releaseTag = `release/${today}`;
            core.exportVariable('RELEASE_TAG', releaseTag);
            console.log(`Release tag: ${releaseTag}`);
            
            // Get the previous release tag for comparison
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1,
            });
            const previousTag = releases.length > 0 ? releases[0].tag_name : null;
            console.log(`Previous tag: ${previousTag}`);
            
            // Generate release notes via GitHub API
            const { data: generatedNotes } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              previous_tag_name: previousTag,
            });
            
            // Append custom section
            const releaseBody = generatedNotes.body + '\n\n## Proposals\n\n[TO BE ADDED]';
            core.exportVariable('RELEASE_BODY', releaseBody);

      # ===== Canister Release (date-based: release/YYYY-MM-DD) =====
      - name: Create GitHub release for canisters
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          body: ${{ env.RELEASE_BODY }}
          files: |
            wasms/ic-btc-canister.wasm.gz
            wasms/watchdog.wasm.gz
            canister/candid.did
            watchdog/candid.did

      # ===== Library Crate Publishing (semver: vX.Y.Z) =====
      - name: Authenticate with crates.io
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish library crates to crates.io
        # Publishes ic-btc-interface and ic-btc-validation (semver-based)
        # Configured in release-plz.toml
        uses: release-plz/action@5ab144c9d67d4346240190d0f95ed08668677928 # v0.5.121
        with:
          command: release
          version: 0.3.151
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Which package to release'
        required: true
        type: choice
        options:
          - ic-btc-canister  # Date-based, uses git-cliff
          - watchdog         # Date-based, uses git-cliff
          - library-crates   # Semver (ic-btc-interface & ic-btc-validation), uses release-plz

# Creates a Release PR for a specific package:
# - ic-btc-canister, watchdog: via git-cliff (date-based)
# - library-crates: via release-plz (semver) - includes ic-btc-interface & ic-btc-validation

jobs:
  # ===== Canister Release PR (date-based) =====
  canister-pr:
    name: Create Release PR for ${{ inputs.package }}
    if: ${{ inputs.package == 'ic-btc-canister' || inputs.package == 'watchdog' }}
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Set release parameters
        run: |
          if [ "${{ inputs.package }}" = "ic-btc-canister" ]; then
            echo "INCLUDE_PATH=canister/**" >> "$GITHUB_ENV"
            echo "CHANGELOG_PATH=canister/CHANGELOG.md" >> "$GITHUB_ENV"
            echo "TAG_PREFIX=release/" >> "$GITHUB_ENV"
          else
            echo "INCLUDE_PATH=watchdog/**" >> "$GITHUB_ENV"
            echo "CHANGELOG_PATH=watchdog/CHANGELOG.md" >> "$GITHUB_ENV"
            echo "TAG_PREFIX=watchdog/release/" >> "$GITHUB_ENV"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release date
        run: |
          RELEASE_DATE=$(date +%Y-%m-%d)
          echo "RELEASE_DATE=$RELEASE_DATE" >> "$GITHUB_ENV"

      - name: Update CHANGELOG
        run: |
          # Get the previous release tag (release/* or watchdog/release/*)
          PREV_TAG=$(git tag --list '${{ env.TAG_PREFIX }}*' --sort=-version:refname | head -n1)
          NEW_TAG="${{ env.TAG_PREFIX }}${{ env.RELEASE_DATE }}"
          
          # Prepend new changelog entry
          git-cliff --config cliff.toml \
            --include-path "${{ env.INCLUDE_PATH }}" \
            --tag-pattern "${{ env.TAG_PREFIX }}.*" \
            --prepend "${{ env.CHANGELOG_PATH }}" \
            --unreleased \
            --tag "$NEW_TAG"
          
          # Append footer link for the new release
          if [ -n "$PREV_TAG" ]; then
            echo "" >> "${{ env.CHANGELOG_PATH }}"
            echo "[$NEW_TAG]: https://github.com/dfinity/bitcoin-canister/compare/${PREV_TAG}...${NEW_TAG}" >> "${{ env.CHANGELOG_PATH }}"
          else
            echo "" >> "${{ env.CHANGELOG_PATH }}"
            echo "[$NEW_TAG]: https://github.com/dfinity/bitcoin-canister/releases/tag/${NEW_TAG}" >> "${{ env.CHANGELOG_PATH }}"
          fi

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ inputs.package }}): update changelog for ${{ env.TAG_PREFIX }}${{ env.RELEASE_DATE }}"
          title: "chore(${{ inputs.package }}): ${{ env.TAG_PREFIX }}${{ env.RELEASE_DATE }}"
          body: |
            ## ${{ inputs.package }} ${{ env.TAG_PREFIX }}${{ env.RELEASE_DATE }}

            This PR updates the changelog for ${{ inputs.package }}.

            After merging, run the **Create GitHub Releases** workflow with `${{ inputs.package }}` selected.
          branch: ${{ env.TAG_PREFIX }}${{ env.RELEASE_DATE }}
          labels: release
          draft: true

  # ===== Library Crates Release PR (semver) =====
  library-crates-pr:
    name: Create Release PR for library crates
    if: ${{ inputs.package == 'library-crates' }}
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release PR (release-plz)
        # Creates a single PR for ic-btc-interface and ic-btc-validation
        uses: release-plz/action@5ab144c9d67d4346240190d0f95ed08668677928 # v0.5.121
        with:
          command: release-pr
          version: 0.3.151
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
